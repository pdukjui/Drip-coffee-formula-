<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü</title>
    <!-- 1. Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* 3. ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Sarabun ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å */
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
        }
        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input number */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div classs="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
        
        <!-- Header -->
        <header class="bg-yellow-800 p-5 text-white">
            <h1 class="text-2xl font-bold text-center">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏£‡∏¥‡∏õ‡∏Å‡∏≤‡πÅ‡∏ü</h1>
        </header>

        <!-- ===== 1. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Setup Screen) ===== -->
        <main id="setupScreen" class="p-6 space-y-5">
            <div>
                <label for="recipeSelect" class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡πÅ‡∏ü:</label>
                <select id="recipeSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                    <!-- ‡∏™‡∏π‡∏ï‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
                </select>
            </div>

            <div>
                <label for="coffeeAmount" class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡πÅ‡∏ü (‡∏Å‡∏£‡∏±‡∏°):</label>
                <input type="number" id="coffeeAmount" value="20" min="10" max="100" class="w-full p-3 border border-gray-300 rounded-lg text-center text-xl font-bold focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
            </div>

            <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ -->
            <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                <div class="flex justify-between items-center text-lg">
                    <span class="text-gray-600">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô (‡∏Å‡∏≤‡πÅ‡∏ü : ‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô):</span>
                    <span id="ratioDisplay" class="font-bold text-gray-900">1 : 15</span>
                </div>
                <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏¢‡πá‡∏ô -->
                <div id="iceWaterSection" class="hidden">
                    <div class="flex justify-between items-center text-lg">
                        <span class="text-gray-600">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á:</span>
                        <span id="iceAmountDisplay" class="font-bold text-blue-600">0 ml</span>
                    </div>
                </div>
                <div class="flex justify-between items-center text-lg">
                    <span class="text-gray-600">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                    <span id="totalWaterDisplay" class="font-bold text-yellow-800 text-xl">300 ml</span>
                </div>
            </div>

            <button id="startDripButton" class="w-full bg-yellow-600 text-white p-4 rounded-lg text-lg font-bold hover:bg-yellow-700 transition duration-200 shadow-md">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏£‡∏¥‡∏õ
            </button>
        </main>

        <!-- ===== 2. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏î‡∏£‡∏¥‡∏õ (Drip Screen) ===== -->
        <main id="dripScreen" class="p-6 space-y-4 hidden flex flex-col items-center">
            <div class="text-6xl font-mono font-bold text-gray-800" id="mainTimer">00:00</div>
            
            <div class="w-full bg-gray-50 p-3 rounded-lg text-center">
                <div class="text-sm text-gray-500">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πÑ‡∏õ</div>
                <div class="text-xl font-bold text-gray-800" id="totalPouredDisplay">0 ml / 300 ml</div>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>

            <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô -->
            <div class="w-full bg-white border border-gray-200 p-5 rounded-lg shadow-inner text-center space-y-2">
                <div id="stepName" class="text-xl font-bold text-yellow-800">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ö‡∏•‡∏π‡∏°</div>
                <div id="stepInstruction" class="text-3xl font-bold text-gray-900">‡πÄ‡∏ó‡∏ô‡πâ‡∏≥ 60 ml</div>
                <div id="stepTimerDisplay" class="text-5xl font-mono font-bold text-blue-600">--:--</div>
            </div>
            
            <button id="nextStepButton" class="w-full bg-blue-600 text-white p-4 rounded-lg text-lg font-bold hover:bg-blue-700 transition duration-200 shadow-md disabled:bg-gray-400">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠
            </button>
            <button id="resetButton" class="w-full bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-gray-300 transition">
                ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
            </button>
        </main>

        <!-- ===== 3. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (Done Screen) ===== -->
        <main id="doneScreen" class="p-10 space-y-4 hidden flex flex-col items-center text-center">
            <div class="text-6xl">üéâ</div>
            <h2 class="text-2xl font-bold text-gray-800">‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h2>
            <div class="text-lg text-gray-600">
                ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="finalTime" class="font-bold">00:00</span>
            </div>
            <p class="text-gray-500">‡∏´‡∏ß‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡πÅ‡∏ü‡∏à‡∏∞‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!</p>
            <button id="restartButton" class="w-full bg-yellow-600 text-white p-4 rounded-lg text-lg font-bold hover:bg-yellow-700 transition duration-200 shadow-md">
                ‡∏î‡∏£‡∏¥‡∏õ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            </button>
        </main>

    </div>

    <script>
        // --- 1. ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡∏ï‡∏£ (Recipes Database) ---
        // calc_type: 'coffee_x' (‡∏Ñ‡∏π‡∏ì‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡πÅ‡∏ü), 'remaining_percent' (‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠), 'total_percent' (‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
        // isIced: true ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏¢‡πá‡∏ô
        // finalRatio: ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡∏Å‡∏≤‡πÅ‡∏ü:‡∏ô‡πâ‡∏≥+‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á)
        const recipes = [
            {
                id: 'classic_15',
                name: '‡∏î‡∏£‡∏¥‡∏ü‡∏£‡πâ‡∏≠‡∏ô: ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏¥‡∏Å (1:15)',
                defaultRatio: 15,
                isIced: false,
                finalRatio: 15,
                steps: [
                    { name: '‡∏ö‡∏•‡∏π‡∏° (Bloom)', calc_type: 'coffee_x', value: 3, duration: 45 }, // 3x ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡πÅ‡∏ü, ‡∏£‡∏≠ 45 ‡∏ß‡∏¥
                    { name: '‡πÄ‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1', calc_type: 'remaining_percent', value: 0.5, duration: 30 }, // 50% ‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠, ‡∏£‡∏≠ 30 ‡∏ß‡∏¥
                    { name: '‡πÄ‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2', calc_type: 'remaining_percent', value: 1.0, duration: 30 }, // 100% ‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠, ‡∏£‡∏≠ 30 ‡∏ß‡∏¥
                ]
            },
            {
                id: 'strong_13',
                name: '‡∏î‡∏£‡∏¥‡∏ü‡∏£‡πâ‡∏≠‡∏ô: ‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô (1:13)',
                defaultRatio: 13,
                isIced: false,
                finalRatio: 13,
                steps: [
                    { name: '‡∏ö‡∏•‡∏π‡∏° (Bloom)', calc_type: 'coffee_x', value: 3, duration: 45 }, // 3x, ‡∏£‡∏≠ 45 ‡∏ß‡∏¥
                    { name: '‡πÄ‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1', calc_type: 'coffee_x', value: 2.5, duration: 30 }, // 2.5x, ‡∏£‡∏≠ 30 ‡∏ß‡∏¥
                    { name: '‡πÄ‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2', calc_type: 'coffee_x', value: 2.5, duration: 30 }, // 2.5x, ‡∏£‡∏≠ 30 ‡∏ß‡∏¥
                    { name: '‡πÄ‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 3', calc_type: 'coffee_x', value: 2.5, duration: 30 }, // 2.5x, ‡∏£‡∏≠ 30 ‡∏ß‡∏¥
                    { name: '‡πÄ‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 4', calc_type: 'coffee_x', value: 2.5, duration: 0 }, // 2.5x, ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠
                ]
            },
            {
                id: 'iced_strong_9_5',
                name: '‡∏î‡∏£‡∏¥‡∏ü‡πÄ‡∏¢‡πá‡∏ô: ‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô (1:9.5)',
                defaultRatio: 9.5, // 9.5 ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏î‡∏£‡∏¥‡∏õ
                isIced: true,
                finalRatio: 15, // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á (‡∏Å‡∏≤‡πÅ‡∏ü:‡∏ô‡πâ‡∏≥+‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á)
                steps: [
                    { name: '‡∏ö‡∏•‡∏π‡∏° (Bloom)', calc_type: 'coffee_x', value: 3, duration: 45 }, 
                    { name: '‡πÄ‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1', calc_type: 'remaining_percent', value: 0.5, duration: 30 },
                    { name: '‡πÄ‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2', calc_type: 'remaining_percent', value: 1.0, duration: 0 }, // ‡πÄ‡∏ó‡∏à‡∏ô‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏´‡∏°‡∏î
                ]
            },
            {
                id: 'iced_standard_10',
                name: '‡∏î‡∏£‡∏¥‡∏ü‡πÄ‡∏¢‡πá‡∏ô: ‡∏™‡∏π‡∏ï‡∏£‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (1:10)',
                defaultRatio: 10, // 10 ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏î‡∏£‡∏¥‡∏õ
                isIced: true,
                finalRatio: 16, // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á (‡∏Å‡∏≤‡πÅ‡∏ü:‡∏ô‡πâ‡∏≥+‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á)
                steps: [
                    { name: '‡∏ö‡∏•‡∏π‡∏° (Bloom)', calc_type: 'coffee_x', value: 3, duration: 45 }, 
                    { name: '‡πÄ‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1', calc_type: 'total_percent', value: 0.5, duration: 30 }, // ‡πÄ‡∏ó‡∏ñ‡∏∂‡∏á 50% ‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô
                    { name: '‡πÄ‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2', calc_type: 'total_percent', value: 0.8, duration: 30 }, // ‡πÄ‡∏ó‡∏ñ‡∏∂‡∏á 80% ‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô
                    { name: '‡πÄ‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 3', calc_type: 'total_percent', value: 1.0, duration: 0 }, // ‡πÄ‡∏ó‡∏à‡∏ô‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏´‡∏°‡∏î
                ]
            }
        ];

        // --- 2. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (State Variables) ---
        let currentRecipe;
        let coffeeGrams = 20;
        let totalHotWater = 0; // ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏î‡∏£‡∏¥‡∏õ
        let totalIce = 0; // ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
        let totalPoured = 0;
        let currentStepIndex = 0;
        let dripState = 'pouring'; // 'pouring' ‡∏´‡∏£‡∏∑‡∏≠ 'waiting'
        let mainTimerSeconds = 0;
        let stepTimerSeconds = 0;
        let mainTimerInterval;
        let stepTimerInterval;

        // --- 3. DOM Elements ---
        const setupScreen = document.getElementById('setupScreen');
        const dripScreen = document.getElementById('dripScreen');
        const doneScreen = document.getElementById('doneScreen');

        const recipeSelect = document.getElementById('recipeSelect');
        const coffeeAmount = document.getElementById('coffeeAmount');
        const ratioDisplay = document.getElementById('ratioDisplay');
        const iceWaterSection = document.getElementById('iceWaterSection');
        const iceAmountDisplay = document.getElementById('iceAmountDisplay');
        const totalWaterDisplay = document.getElementById('totalWaterDisplay');
        const startDripButton = document.getElementById('startDripButton');

        const mainTimer = document.getElementById('mainTimer');
        const totalPouredDisplay = document.getElementById('totalPouredDisplay');
        const progressBar = document.getElementById('progressBar');
        const stepName = document.getElementById('stepName');
        const stepInstruction = document.getElementById('stepInstruction');
        const stepTimerDisplay = document.getElementById('stepTimerDisplay');
        const nextStepButton = document.getElementById('nextStepButton');
        const resetButton = document.getElementById('resetButton');
        
        const finalTime = document.getElementById('finalTime');
        const restartButton = document.getElementById('restartButton');

        // --- 4. Helper Functions ---
        
        /** ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) ‡πÄ‡∏õ‡πá‡∏ô "mm:ss" */
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        /** ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô */
        function calculateWaterForStep(step) {
            let water = 0;
            const remainingWater = totalHotWater - totalPoured;
            
            switch (step.calc_type) {
                case 'coffee_x':
                    water = coffeeGrams * step.value;
                    break;
                case 'remaining_percent':
                    water = remainingWater * step.value;
                    break;
                case 'total_percent':
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó "‡πÄ‡∏û‡∏¥‡πà‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ô‡∏±‡πâ‡∏ô
                    const targetTotal = totalHotWater * step.value;
                    water = targetTotal - totalPoured;
                    break;
            }
            // ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô
            return Math.min(Math.round(water), remainingWater);
        }

        /** ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ */
        function updateSetupUI() {
            currentRecipe = recipes.find(r => r.id === recipeSelect.value);
            coffeeGrams = parseInt(coffeeAmount.value) || 20;
            
            // ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏î‡∏£‡∏¥‡∏õ (Hot Water)
            totalHotWater = Math.round(coffeeGrams * currentRecipe.defaultRatio);
            
            ratioDisplay.textContent = `1 : ${currentRecipe.defaultRatio}`;
            totalWaterDisplay.textContent = `${totalHotWater} ml`;
            
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ï‡∏£‡∏î‡∏£‡∏¥‡∏õ‡πÄ‡∏¢‡πá‡∏ô
            if (currentRecipe.isIced) {
                iceWaterSection.classList.remove('hidden');
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á: ‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ï‡∏≤‡∏° finalRatio) - ‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏î‡∏£‡∏¥‡∏õ
                // Iced Ratio (e.g., 1:15 or 1:16) = Coffee : (Hot Water + Ice)
                const totalLiquidNeeded = Math.round(coffeeGrams * currentRecipe.finalRatio);
                totalIce = Math.max(0, totalLiquidNeeded - totalHotWater); // ‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏•‡∏ö
                
                iceAmountDisplay.textContent = `${totalIce} ml`;
            } else {
                iceWaterSection.classList.add('hidden');
                totalIce = 0;
            }
        }

        /** ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Progress Bar */
        function updateProgressBar() {
            const percent = (totalPoured / totalHotWater) * 100;
            progressBar.style.width = `${percent}%`;
            totalPouredDisplay.textContent = `${Math.round(totalPoured)} ml / ${totalHotWater} ml`;
        }


        // --- 5. Main Logic Functions ---

        /** ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏ô‡πâ‡∏≥ */
        function showPourStep(stepIndex) {
            dripState = 'pouring';
            const step = currentRecipe.steps[stepIndex];
            if (!step) {
                showDoneScreen();
                return;
            }
            
            const waterForThisStep = calculateWaterForStep(step);
            const targetWater = totalPoured + waterForThisStep;
            
            stepName.textContent = `‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${stepIndex + 1}: ${step.name}`;
            stepInstruction.textContent = `‡πÄ‡∏ó‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á ${Math.round(targetWater)} ml`;
            stepTimerDisplay.textContent = '--:--';
            nextStepButton.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠';
            nextStepButton.disabled = false;
            
            if (step.duration === 0) {
                nextStepButton.textContent = '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
            }
        }

        /** ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏≠ */
        function showWaitStep(stepIndex) {
            dripState = 'waiting';
            const step = currentRecipe.steps[stepIndex];
            stepTimerSeconds = step.duration;

            stepName.textContent = '‡∏£‡∏≠... (Wait)';
            stepInstruction.textContent = `‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${step.duration} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
            stepTimerDisplay.textContent = formatTime(stepTimerSeconds);
            nextStepButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤...';
            nextStepButton.disabled = true;

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
            clearInterval(stepTimerInterval);
            stepTimerInterval = setInterval(() => {
                stepTimerSeconds--;
                stepTimerDisplay.textContent = formatTime(stepTimerSeconds);
                
                if (stepTimerSeconds <= 0) {
                    clearInterval(stepTimerInterval);
                    stepTimerDisplay.textContent = '00:00';
                    nextStepButton.textContent = '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
                    nextStepButton.disabled = false;
                    // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                    try {
                        // Vibrate on mobile devices for 200ms
                        if ('vibrate' in navigator) {
                            navigator.vibrate(200); 
                        }
                    } catch (e) {
                        console.error('Vibrate failed:', e);
                    }
                }
            }, 1000);
        }

        /** ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô */
        function showDoneScreen() {
            clearInterval(mainTimerInterval);
            clearInterval(stepTimerInterval);
            dripScreen.classList.add('hidden');
            dripScreen.classList.remove('flex');
            doneScreen.classList.remove('hidden');
            finalTime.textContent = formatTime(mainTimerSeconds);
        }

        /** ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ" */
        function handleNextClick() {
            const step = currentRecipe.steps[currentStepIndex];
            if (!step) return;

            if (dripState === 'pouring') {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏ó‡πÄ‡∏™‡∏£‡πá‡∏à, ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                const waterForThisStep = calculateWaterForStep(step);
                totalPoured += waterForThisStep;
                updateProgressBar();

                if (step.duration > 0) {
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠ ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏£‡∏≠
                    showWaitStep(currentStepIndex);
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)
                    currentStepIndex++;
                    if (currentStepIndex >= currentRecipe.steps.length) {
                        showDoneScreen();
                    } else {
                        showPourStep(currentStepIndex);
                    }
                }
            } else if (dripState === 'waiting') {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏£‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à, ‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                currentStepIndex++;
                if (currentStepIndex >= currentRecipe.steps.length) {
                    showDoneScreen();
                } else {
                    showPourStep(currentStepIndex);
                }
            }
        }

        /** ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏£‡∏¥‡∏õ */
        function startDrip() {
            // 1. ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏£‡∏¥‡∏õ
            setupScreen.classList.add('hidden');
            dripScreen.classList.remove('hidden');
            dripScreen.classList.add('flex');
            doneScreen.classList.add('hidden');

            // 2. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤
            currentStepIndex = 0;
            totalPoured = 0;
            mainTimerSeconds = 0;
            mainTimer.textContent = '00:00';
            updateProgressBar();

            // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏•‡∏±‡∏Å
            clearInterval(mainTimerInterval);
            mainTimerInterval = setInterval(() => {
                mainTimerSeconds++;
                mainTimer.textContent = formatTime(mainTimerSeconds);
            }, 1000);

            // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å
            showPourStep(0);
        }
        
        /** ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏≠‡∏õ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ */
        function handleReset() {
            clearInterval(mainTimerInterval);
            clearInterval(stepTimerInterval);
            
            dripScreen.classList.add('hidden');
            dripScreen.classList.remove('flex');
            doneScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ setup
        }

        /** ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ */
        function init() {
            // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏π‡∏ï‡∏£‡∏•‡∏á‡πÉ‡∏ô select
            recipes.forEach(recipe => {
                const option = document.createElement('option');
                option.value = recipe.id;
                option.textContent = recipe.name;
                recipeSelect.appendChild(option);
            });
            
            // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
            updateSetupUI();

            // 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners
            recipeSelect.addEventListen'‡∏£‡πâ‡∏≠‡∏ô‡∏£‡πâ‡∏≠‡∏ô
